{% extends "layout.html" %}
{% block title %}
Seed Library
{% endblock %}
{% block content %}
<!-- Seed Header -->
<div class="seedPlantHeader">
    <div class="seedItemButton">
        <button class="button" onclick="openPopup('addSeedPopup')">Add Seed</button>
    </div>
    <div class="seedItemButton">
        <button class="button">Remove Seed</button>
    </div>
    <div class="seedItemButton">
        <select id="seedRefine" name="seedRefine">
            <option value="" disabled selected hidden>Refine</option>
        </select>
    </div>
    <div class="searchBar">
        <input type="text" id="seedSearchBar" placeholder="Search..">
    </div>
</div>
<div id="seedLibraryContainer">
    <!-- Basic Info -->
    {% for seed in user_seeds %}
    <div class="BasicInfo">
        <button class="InfoButton" onclick="openPopup('seedPopup{{ seed.id }}')">
            <img src="{{url_for('static', filename='uploads/seed_images/' + seed.image_filename)}}" alt="Seed Image">
            <div class="infoDetails">
                <p>{{ seed.name }}</p>
            </div>
            <div class="infoDetails">
                <p>{{ seed.plant_type }}</p>
            </div>
            <div class="infoDetails">
                <p>{{ seed.when_to_plant }}</p>
            </div>
        </button>
        <label class="containerInfo">
            <input type="checkbox" id="checkboxSeed{{ seed.id }}">
        </label>
    </div>

    <!-- Seed Information Popup -->
    <div class="seedPopup" id="seedPopup{{ seed.id }}">
        <h2>{{ seed.name }}</h2>
        <div class="infoContainer">
            <div class="seedImage"> 
                <img src="{{url_for('static', filename='uploads/seed_images/' + seed.image_filename)}}" alt="Seed Image">
            </div>
            <div class="infoBackground"><p id="plantType">{{ seed.plant_type }}</p></div>
            <div class="infoBackground"><p id="germinateTime">{{ seed.germinate_time }}</p></div>
            <div class="infoBackground"><p id="maturityTime">{{ seed.maturity_time }}</p></div>
            <div class="infoBackground"><p id="plantingDepth">{{ seed.planting_depth }}</p></div>
            <div class="infoBackground"><p id="plantSpacing">{{ seed.plant_spacing }}</p></div>
            <div class="infoBackground"><p id="sunRequirement">{{ seed.sun_requirement }}</p></div>
            <div class="infoBackground"><p id="whenToPlant">{{ seed.when_to_plant }}</p></div>
            <button class="seedExit" onclick="closePopup('seedPopup{{ seed.id }}')">Exit</button>
        </div>
    </div>
    {% endfor %}
</div>
<!-- Add Seed Popup -->
<div class="seedPopup" id="addSeedPopup">
    <form id="addSeedForm" action="/add_seed" method="post" enctype="multipart/form-data" onsubmit="submitForm(); return false;">
        <input type="text" id="addSeedName" class="infoBackground" placeholder="Seed Name" required>
        <div class="addSeedLayout">
            <div class="addSeedLeft">
                <div class="imageUpload">
                    <img id="previewSeedImage" src="{{url_for('static', filename='img/defaultimg.png')}}" alt="Default Image">
                    <input type="file" id="addSeedImage" accept="image/*" onchange="previewImage()">
                </div>
                <button type="submit" class="addSeedExit" onclick="closePopupRefresh('addSeedPopup')">Submit</button>
            </div>
            <div class="addSeedRight">
                <input type="text" id="addSeedType" class="infoBackground" placeholder="Plant Type" required>
                <input type="number" id="addSeedGermination" class="infoBackground" placeholder="Germination Time &#40;days&#41;" required>
                <input type="number" id="addSeedMaturity" class="infoBackground" placeholder="Maturity Time &#40;weeks&#41;" required>
                <input type="number" id="addSeedDepth" class="infoBackground" placeholder="Sow Depth &#40;mm&#41;" required>
                <input type="number" id="addSeedSpacing" class="infoBackground" placeholder="Plant Spacing &#40;cm&#41;" required>
                <select id="addSeedSun" class="infoBackground" name="addSeedSun" required>
                    <option value="" disabled selected hidden>Sun Requirement</option>
                    <option value="fullSun">Full Sun</option>
                    <option value="partSun">Part Sun</option>
                    <option value="shade">Shade</option>
                </select>
                <select id="addSeedSeason" class="infoBackground" name="addSeedSeason" required>
                    <option value="" disabled selected hidden>When to Plant</option>
                    <option value="Summer">Summer</option>
                    <option value="Autumn">Autumn</option>
                    <option value="Winter">Winter</option>
                    <option value="Spring">Spring</option>
                </select>
            </div>
        </div>
    </form>
        <button class="addSeedExit" onclick="closePopup('addSeedPopup')">Exit</button>
</div>

<!-- Javascript -->
<script>
    function openPopup(popupId) {
    document.getElementById(popupId).classList.add("open-popup");
    }

    function closePopup(popupId) {
        document.getElementById(popupId).classList.remove("open-popup");
        location.reload()
    }

    function closePopupRefresh(popupId) {
    document.getElementById(popupId).classList.remove("open-popup");

    // Reload the content of the seed library using AJAX
    fetch('/reloadSeedLibrary', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('seedLibraryContainer').innerHTML = html;
    })
    .catch(error => console.error('Error:', error));
    }

    /* Function to preview selected image */
    function previewImage() {
        const input = document.getElementById('addSeedImage');              //Gets input element with id 'addSeedImage'
        const preview = document.getElementById('previewSeedImage');        //Gets image element with id 'previewSeedImage'

        const file = input.files[0];            //Gets the first file from the selected files in the input element

        console.log('Selected File:', file);

        if (file) {                             //Checks if a file is selected
            const reader = new FileReader();    //Creates a FileReader object
            reader.onload = function (e) {      //Defnes event handler for when FileReader has loaded the file
                preview.src = e.target.result;  //Sets the source of preview image to the result of reading the file as a data URL
            };
            reader.readAsDataURL(file);         //Reads the file as a data URL
        } else {
            // Set the preview image back to the default source if no file is selected
            preview.src = "path/to/default-image.jpg";
        }
    }

    /* Function to submit the form */
    function submitForm() {
    const form = document.getElementById('addSeedForm');    //Gets form element with the id 'addSeedForm'
    const formData = new FormData(form);                    //Creates new FormData object from the form

    const seedName = document.getElementById('addSeedName').value;  //Gets element with id addSeedName
    formData.append('addSeedName', seedName);                       //Append the Seed Name to formData, with key                     

    const seedType = document.getElementById('addSeedType').value;
    formData.append('addSeedType', seedType);

    const germinationTime = document.getElementById('addSeedGermination').value;
    formData.append('addSeedGermination', germinationTime);

    const seedDepth = document.getElementById('addSeedDepth').value;
    formData.append('addSeedDepth', seedDepth);

    const seedSpace = document.getElementById('addSeedSpacing').value;
    formData.append('addSeedSpacing', seedSpace);

    const seedMature = document.getElementById('addSeedMaturity').value;
    formData.append('addSeedMaturity', seedMature);

    const seedSun = document.getElementById('addSeedSun').value;
    formData.append('addSeedSun', seedSun);

    const seedSeason = document.getElementById('addSeedSeason').value;
    formData.append('addSeedSeason', seedSeason);
    
    const imageInput = document.getElementById('addSeedImage');
    const imageFile = imageInput.files[0];

    formData.append('addSeedImage', imageFile);

    console.log(formData);

    for (const entry of formData.entries()) {
    console.log(entry);
    }

    // Make an AJAX request to submit the form data
    fetch('/add_seed', {
        method: 'POST',                         //Specifies HTTP method as POST
        body: formData                          //Sets request body to the FormData object
    }).then(response => {
        // Handle the response if needed
        console.log(response);                  //Logs response to the console
    }).catch(error => {
        console.error('Error:', error);         //Log error message to console if there is an error
    });
}
</script>
{% endblock %}